{% extends "base.html" %}

{% block content %}
<div class="container-lg py-5">
    <!-- Profile Hero Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); border-radius: 20px; padding: 3rem 2rem; box-shadow: 0 10px 40px rgba(5,150,105,0.15);">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 70px; height: 70px; background: rgba(255,255,255,0.15); border-radius: 16px; margin-bottom: 1.5rem;">
                            <span style="font-size: 2rem;">üë®‚Äçüåæ</span>
                        </div>
                        <h1 style="font-size: 2.5rem; font-weight: 800; color: #ffffff; margin-bottom: 0.5rem;"><span id="profileTitle">Farmer Profile</span> ‚Äî <span id="profileName" style="color: #d1fae5;">{{ farmer.name or session.get('user_name') }}</span></h1>
                        <p id="profileSubtitle" style="font-size: 1.1rem; color: rgba(255,255,255,0.85);">Manage your crop batches and farming data</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <small style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem;" id="memberSinceLabel">Member since</small>
                            <p style="font-size: 1.2rem; color: #ffffff; margin: 0; font-weight: 700;">{{ farmer.created_at[:10] if farmer.created_at else 'Recently' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Status (Quick Stats) moved to top -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 1rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="color: white; font-weight: 700;">üìä My Status</h6>
                        <button id="profileLangToggle" type="button" class="btn btn-sm btn-outline-light" style="font-weight:700;">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row text-center g-3">
                        <div class="col-6 col-md-3">
                            <h4 class="text-success" id="totalBatches" style="font-weight: 800; color: #047857;">0</h4>
                            <small id="labelTotalBatches" style="color: #6b7280;">Total Batches</small>
                        </div>
                        <div class="col-6 col-md-3">
                            <h4 class="text-info" id="activeBatchesCount" style="font-weight: 800; color: #0284c7;">0</h4>
                            <small id="labelActive" style="color: #6b7280;">Active</small>
                        </div>
                        <div class="col-6 col-md-3">
                            <h4 style="font-weight: 800; color: #7c3aed;" id="completedBatches">0</h4>
                            <small id="labelCompleted" style="color: #6b7280;">Completed</small>
                        </div>
                        <div class="col-6 col-md-3">
                            <h4 style="font-weight: 800; color: #059669;" id="totalWeight">0kg</h4>
                            <small id="labelTotalWeight" style="color: #6b7280;">Total Weight</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column - Profile Information -->
        <div class="col-lg-4">
            <!-- Profile Card -->
            <div class="card border-0 mb-4" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; padding: 1.5rem;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="profileInfoTitle">üìù Profile Information</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('auth.update_profile') }}">
                        <div class="mb-3">
                            <label class="form-label" style="color: #1e293b; font-weight: 600;" id="locationLabel">Farm Location (Latitude / Longitude)</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" name="latitude" id="latitudeInput"
                                       value="{{ farmer.latitude or farmer.lat or '' }}" placeholder="Latitude"
                                       style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem;">
                                <input type="text" class="form-control" name="longitude" id="longitudeInput"
                                       value="{{ farmer.longitude or farmer.lon or farmer.lng or '' }}" placeholder="Longitude"
                                       style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem;">
                            </div>
                            <div class="mb-2">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="useLocationBtn">Use Current Location</button>
                                <small class="text-muted ms-2">You can update your farm coordinates here to center maps and risk calculations.</small>
                            </div>
                            <div id="locationPreview" class="mt-2" style="min-height:140px;"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="color: #1e293b; font-weight: 600;" id="fullNameLabel">Full Name</label>
                            <input type="text" class="form-control" name="name"
                                   value="{{ farmer.name }}" required
                                   style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem; transition: all 0.3s ease;">
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="color: #1e293b; font-weight: 600;" id="emailLabel">Email</label>
                            <input type="email" class="form-control" value="{{ farmer.email }}" readonly
                                   style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem; background: #f3f4f6;">
                            <small class="text-muted" id="emailCannotChange">Email cannot be changed</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="color: #1e293b; font-weight: 600;" id="phoneLabel">Phone</label>
                            <input type="text" class="form-control" name="phone"
                                   value="{{ farmer.phone or '' }}" placeholder="Enter phone number"
                                   style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem;">
                        </div>

                        <div class="mb-4">
                            <label class="form-label" style="color: #1e293b; font-weight: 600;" id="languageLabel">Preferred Language</label>
                            <select class="form-select" name="preferred_language"
                                    style="border: 2px solid #e5e7eb; border-radius: 10px; padding: 0.75rem;">
                                <option value="en" {% if farmer.preferred_language == 'en' %}selected{% endif %}>English</option>
                                <option value="bn" {% if farmer.preferred_language == 'bn' %}selected{% endif %}>Bangla</option>
                            </select>
                        </div>

                        <button id="updateProfileBtn" type="submit" class="btn w-100"
                                style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(5,150,105,0.2)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            üíæ <span id="updateProfileBtnText">Update Profile</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Left column continues (quick stats moved to top) -->
        </div>

        <!-- Right Column - Crop Batch Management -->
        <div class="col-lg-8">
            <!-- All Crop Batches -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;">üåæ <span id="allBatchesTitle">All Crop Batches</span></h5>
                    <div>
                        <span class="badge" style="background: rgba(255,255,255,0.25); color: white; padding: 0.5rem 1rem; border-radius: 20px;" id="totalCount">0 total</span>
                        <a id="btnAddNew" href="{{ url_for('crops.add_crop') }}" class="btn btn-light btn-sm ms-2" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">‚ûï <span id="addNewText">Add New</span></a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- Filter Buttons -->
                    <div class="btn-group w-100 mb-4" role="group" style="border-bottom: 2px solid #e5e7eb; padding-bottom: 1.5rem;">
                        <button type="button" class="btn btn-outline-success active" onclick="filterBatches('all')" style="font-weight: 600; border-radius: 8px; padding: 0.75rem 1.5rem;" id="btnAllBatches">
                            All Batches
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="filterBatches('active')" style="font-weight: 600; border-radius: 8px; padding: 0.75rem 1.5rem;" id="btnActiveBatches">
                            Active
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="filterBatches('completed')" style="font-weight: 600; border-radius: 8px; padding: 0.75rem 1.5rem;" id="btnCompletedBatches">
                            Completed
                        </button>
                    </div>

                    <!-- Batch List -->
                    <div id="allBatchesList">
                        <div class="text-center py-5">
                            <div class="spinner-border" style="color: #059669;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3" style="color: #6b7280;">Loading your crop batches...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 16px; border: none;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; padding: 1.5rem;">
                <h5 class="modal-title" id="modalTitle" style="font-weight: 700;">Confirm Action</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                Are you sure you want to perform this action?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load profile data
async function loadProfileData() {
    console.log("üîÑ Loading profile data...");
    try {
        await loadAllBatches();
        await loadProfileStats();
    } catch (error) {
        console.error('‚ùå Error loading profile data:', error);
        showError('Failed to load profile data: ' + error.message);
    }
}

// Load all batches
async function loadAllBatches() {
    try {
        console.log("üå± Fetching all batches from /api/crops/all");
        const response = await fetch('/api/crops/all', { credentials: 'same-origin' });
        
        console.log("üå± Response status:", response.status);
        
        if (response.ok) {
            const batches = await response.json();
            console.log("üå± Received batches:", batches);
            displayAllBatches(batches);
        } else {
            const errorData = await response.json();
            console.error("‚ùå API Error:", errorData);
            showError('Failed to load batches: ' + (errorData.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('‚ùå Network error loading batches:', error);
        showError('Network error loading batches: ' + error.message);
    }
}

// Display all batches
function displayAllBatches(batches) {
    console.log("üìã Displaying batches:", batches);

    const batchesList = document.getElementById('allBatchesList');

    // save last fetched batches for filtering and counts
    window.__lastBatches = batches || [];

    if (!batches || batches.length === 0) {
        console.log("üìã No batches to display");
        batchesList.innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted">No crop batches found.</p>
                <a href="{{ url_for('crops.add_crop') }}" class="btn btn-success">Add Your First Batch</a>
            </div>
        `;
        return;
    }

    console.log("üìã Rendering", batches.length, "batches");
    batchesList.innerHTML = batches.map(batch => `
        <div class="batch-item card mb-3 ${batch.status === 'completed' ? 'border-secondary' : 'border-success'}" data-status="${batch.status}">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <h6 class="mb-1 text-capitalize">${batch.crop_type || 'Crop'}</h6>
                        <small class="text-muted d-block">
                            üìç ${batch.storage_location || 'Unknown'} ‚Ä¢ 
                            üóìÔ∏è ${new Date(batch.harvest_date).toLocaleDateString()}
                        </small>
                        <small class="text-muted">
                            Created: ${new Date(batch.created_at).toLocaleDateString()}
                        </small>
                    </div>
                    <div class="col-md-3">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar ${getStatusColor(batch.status)}" 
                                 style="width: ${batch.status === 'completed' ? 100 : 70}%"></div>
                        </div>
                        <small>${batch.estimated_weight || 0} kg</small>
                        ${batch.notes ? `<br><small class="text-muted">${batch.notes}</small>` : ''}
                    </div>
                    <div class="col-md-2 text-center">
                        <span class="badge ${getStatusBadge(batch.status)}">
                            ${batch.status.toUpperCase()}
                        </span>
                        <br>
                        <small class="text-muted ${getRiskLevelColor(batch.current_risk_level)}">
                            ${(batch.current_risk_level || 'low').toUpperCase()} risk
                        </small>
                    </div>
                    <div class="col-md-2 text-end">
                        ${batch.status === 'active' ? `
                            <button class="btn btn-warning btn-sm mb-1" onclick="completeBatch('${batch.id}')">
                                ‚úÖ Complete
                            </button>
                            <br>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteBatch('${batch.id}')">
                                üóëÔ∏è Delete
                            </button>
                        ` : `
                            <button class="btn btn-success btn-sm mb-1" onclick="reactivateBatch('${batch.id}')">
                                üîÑ Reactivate
                            </button>
                            <br>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteBatch('${batch.id}')">
                                üóëÔ∏è Delete
                            </button>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    updateBatchCounts(batches);
}

// Show error message (better version)
function showError(message) {
    const batchesList = document.getElementById('allBatchesList');
    batchesList.innerHTML = `
        <div class="alert alert-danger">
            <strong>‚ùå Error:</strong> ${message}
            <br><br>
            <button onclick="loadProfileData()" class="btn btn-warning btn-sm">Try Again</button>
            <a href="{{ url_for('crops.add_crop') }}" class="btn btn-success btn-sm">Add New Batch</a>
        </div>
    `;
}

// ----------------- Helper UI functions -----------------
function getStatusColor(status) {
    if (!status) return 'bg-info';
    status = status.toLowerCase();
    if (status === 'completed') return 'bg-secondary';
    if (status === 'active') return 'bg-success';
    return 'bg-info';
}

function getStatusBadge(status) {
    if (!status) return 'badge bg-info';
    status = status.toLowerCase();
    if (status === 'completed') return 'badge bg-secondary';
    if (status === 'active') return 'badge bg-success';
    return 'badge bg-info';
}

function getRiskLevelColor(risk) {
    if (!risk) return 'text-success';
    risk = risk.toLowerCase();
    if (risk === 'high') return 'text-danger';
    if (risk === 'medium') return 'text-warning';
    return 'text-success';
}

function updateBatchCounts(batches) {
    batches = batches || window.__lastBatches || [];
    const total = batches.length;
    const active = batches.filter(b => (b.status || '').toLowerCase() === 'active').length;
    const completed = batches.filter(b => (b.status || '').toLowerCase() === 'completed').length;
    const totalWeight = batches.reduce((s, b) => s + (parseFloat(b.estimated_weight) || 0), 0);

    const elTotal = document.getElementById('totalBatches');
    const elActive = document.getElementById('activeBatchesCount');
    const elCompleted = document.getElementById('completedBatches');
    const elWeight = document.getElementById('totalWeight');
    const badge = document.getElementById('totalCount');

    if (elTotal) elTotal.textContent = total;
    if (elActive) elActive.textContent = active;
    if (elCompleted) elCompleted.textContent = completed;
    if (elWeight) elWeight.textContent = totalWeight + 'kg';
    if (badge) badge.textContent = total + ' total';
}

function filterBatches(mode) {
    // update button active classes
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    const buttons = Array.from(document.querySelectorAll('.btn-group .btn'));
    const matched = buttons.find(b => b.textContent.trim().toLowerCase().includes(mode));
    if (matched) matched.classList.add('active');

    const items = document.querySelectorAll('.batch-item');
    items.forEach(it => {
        const status = it.getAttribute('data-status') || '';
        if (mode === 'all') {
            it.style.display = '';
        } else if (mode === 'active') {
            it.style.display = (status.toLowerCase() === 'active') ? '' : 'none';
        } else if (mode === 'completed') {
            it.style.display = (status.toLowerCase() === 'completed') ? '' : 'none';
        }
    });
}

async function completeBatch(id) {
    if (!confirm('Mark this batch as completed?')) return;
    try {
        const res = await fetch(`/api/crops/${id}/complete`, { method: 'POST', credentials: 'same-origin' });
        if (res.ok) {
            await loadAllBatches();
        } else {
            const err = await res.json().catch(()=>({error:'unknown'}));
            alert('Failed to complete batch: ' + (err.error || res.status));
        }
    } catch (e) {
        alert('Network error: ' + e.message);
    }
}

async function reactivateBatch(id) {
    if (!confirm('Reactivate this batch?')) return;
    try {
        const res = await fetch(`/api/crops/${id}/reactivate`, { method: 'POST', credentials: 'same-origin' });
        if (res.ok) {
            await loadAllBatches();
        } else {
            const err = await res.json().catch(()=>({error:'unknown'}));
            alert('Failed to reactivate batch: ' + (err.error || res.status));
        }
    } catch (e) {
        alert('Network error: ' + e.message);
    }
}

async function deleteBatch(id) {
    if (!confirm('Delete this batch permanently?')) return;
    try {
        const res = await fetch(`/api/crops/${id}`, { method: 'DELETE', credentials: 'same-origin' });
        if (res.ok) {
            await loadAllBatches();
        } else {
            const err = await res.json().catch(()=>({error:'unknown'}));
            alert('Failed to delete batch: ' + (err.error || res.status));
        }
    } catch (e) {
        alert('Network error: ' + e.message);
    }
}

// Load simple profile stats and update UI
async function loadProfileStats() {
    try {
        console.log("üìä Fetching dashboard stats from /api/dashboard/stats");
        const resp = await fetch('/api/dashboard/stats', { credentials: 'same-origin' });
        if (!resp.ok) {
            console.warn('Unable to load stats', resp.status);
            return;
        }
        const stats = await resp.json();
        console.log('üìä Stats received', stats);

        document.getElementById('totalBatches').textContent = (stats.active_batches || 0) + ' (may vary)';
        document.getElementById('activeBatchesCount').textContent = stats.active_batches || 0;
        document.getElementById('totalWeight').textContent = (stats.total_weight || 0) + 'kg';
        // completedBatches not provided by endpoint; leave as-is or compute if needed
        const totalBadge = document.getElementById('totalCount');
        if (totalBadge) totalBadge.textContent = (stats.active_batches || 0) + ' active';

    } catch (e) {
        console.error('‚ùå Error loading profile stats:', e);
    }
}

    // Ensure we load data when the page finishes loading
    document.addEventListener('DOMContentLoaded', function() {
        loadProfileData();
        // Update content with current language
        updateContent();

        // If coordinates already present in inputs, show preview
        const latEl = document.getElementById('latitudeInput');
        const lngEl = document.getElementById('longitudeInput');
        if (latEl && lngEl && latEl.value && lngEl.value) {
            showLocationPreview(latEl.value, lngEl.value);
        }

        // Listen for language changes
        window.addEventListener('languageChanged', function() {
            updateContent();
        });

        // Profile page language toggle button (keeps text synced with global toggle)
        const profileLangBtn = document.getElementById('profileLangToggle');
        if (profileLangBtn) {
            function refreshProfileLangBtn() {
                try {
                    const label = (translations[currentLang] && translations[currentLang].langToggle) ? translations[currentLang].langToggle : (currentLang === 'en' ? 'Bangla' : 'English');
                    profileLangBtn.textContent = label;
                } catch (e) { /* ignore */ }
            }
            refreshProfileLangBtn();
            profileLangBtn.addEventListener('click', function() { toggleLanguage(); });
            window.addEventListener('languageChanged', refreshProfileLangBtn);
        }
    });

// Add English/Bangla translations for profile page
const profileTranslations = {
    en: {
        profileTitle: 'Farmer Profile',
        profileSubtitle: 'Manage your crop batches and farming data',
        memberSinceLabel: 'Member since',
        profileInfoTitle: 'Profile Information',
        fullNameLabel: 'Full Name',
        emailLabel: 'Email',
        emailCannotChange: 'Email cannot be changed',
        phoneLabel: 'Phone',
        languageLabel: 'Preferred Language',
        updateProfileBtnText: 'Update Profile',
        farmingStatsTitle: 'Your Farming Stats',
        labelTotalBatches: 'Total Batches',
        labelActive: 'Active',
        labelCompleted: 'Completed',
        labelTotalWeight: 'Total Weight',
        allBatchesTitle: 'All Crop Batches',
        btnAllBatches: 'All Batches',
        btnActiveBatches: 'Active',
        btnCompletedBatches: 'Completed',
        addNewText: 'Add New'
    },
    bn: {
        profileTitle: '‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
        profileSubtitle: '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∏‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶è‡¶¨‡¶Ç ‡¶ö‡¶æ‡¶∑‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®',
        memberSinceLabel: '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®',
        profileInfoTitle: '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø',
        fullNameLabel: '‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ',
        emailLabel: '‡¶á‡¶Æ‡ßá‡¶≤',
        emailCannotChange: '‡¶á‡¶Æ‡ßá‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶®‡¶æ',
        phoneLabel: '‡¶´‡ßã‡¶®',
        languageLabel: '‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶≠‡¶æ‡¶∑‡¶æ',
        updateProfileBtnText: '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
        farmingStatsTitle: '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶∑‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®',
        labelTotalBatches: '‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        labelActive: '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º',
        labelCompleted: '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®',
        labelTotalWeight: '‡¶Æ‡ßã‡¶ü ‡¶ì‡¶ú‡¶®',
        allBatchesTitle: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶´‡¶∏‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        btnAllBatches: '‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        btnActiveBatches: '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º',
        btnCompletedBatches: '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®',
        addNewText: '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®'
    }
};

// Merge with global translations
Object.assign(translations.en, profileTranslations.en);
Object.assign(translations.bn, profileTranslations.bn);

    // Helper: ensure Leaflet is loaded (CSS + JS) then call cb
    function ensureLeaflet(cb) {
        if (window.L) return cb();
        // load CSS
        if (!document.querySelector('link[data-leaflet]')) {
            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            css.setAttribute('data-leaflet', '1');
            document.head.appendChild(css);
        }
        // load JS
        if (!document.querySelector('script[data-leaflet]')) {
            const s = document.createElement('script');
            s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            s.setAttribute('data-leaflet', '1');
            s.onload = cb;
            document.head.appendChild(s);
        } else {
            // already loading
            const existing = document.querySelector('script[data-leaflet]');
            existing.addEventListener('load', function() { cb(); });
        }
    }

    // Update inputs + preview label and osm link
    function updateInputsAndPreview(lat, lng) {
        const latEl = document.getElementById('latitudeInput');
        const lngEl = document.getElementById('longitudeInput');
        if (latEl) latEl.value = parseFloat(lat).toFixed(6);
        if (lngEl) lngEl.value = parseFloat(lng).toFixed(6);
        const previewText = document.querySelector('#locationPreview .preview-text');
        if (previewText) previewText.innerHTML = `Selected location: <strong>${parseFloat(lat).toFixed(6)}</strong>, <strong>${parseFloat(lng).toFixed(6)}</strong>`;
        const osmLink = document.querySelector('#locationPreview .osm-link');
        if (osmLink) osmLink.href = `https://www.openstreetmap.org/?mlat=${parseFloat(lat)}&mlon=${parseFloat(lng)}#map=16/${parseFloat(lat)}/${parseFloat(lng)}`;
    }

    // Helper: display an interactive Leaflet map and marker for given lat/lng
    function showLocationPreview(lat, lng) {
        const preview = document.getElementById('locationPreview');
        if (!preview) return;
        const latNum = parseFloat(lat);
        const lngNum = parseFloat(lng);
        if (Number.isNaN(latNum) || Number.isNaN(lngNum)) {
            preview.innerHTML = '<div class="text-danger">Invalid coordinates</div>';
            return;
        }

        // Insert map container and header
        preview.innerHTML = `
            <div class="preview-text" style="font-size:0.9rem; margin-bottom:6px;">Selected location: <strong>${latNum.toFixed(6)}</strong>, <strong>${lngNum.toFixed(6)}</strong></div>
            <div id="locationMap" style="width:100%; height:260px; border:1px solid #ddd; border-radius:6px;"></div>
            <div class="mt-2"><a class="osm-link" href="https://www.openstreetmap.org/?mlat=${latNum}&mlon=${lngNum}#map=16/${latNum}/${lngNum}" target="_blank" rel="noopener">Open in OpenStreetMap</a></div>
        `;

        ensureLeaflet(function() {
            // initialize map if not present
            try {
                if (!window.profileMap) {
                    window.profileMap = L.map('locationMap').setView([latNum, lngNum], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(window.profileMap);
                    window.profileMarker = L.marker([latNum, lngNum], { draggable: true }).addTo(window.profileMap);

                    window.profileMarker.on('dragend', function(e) {
                        const p = e.target.getLatLng();
                        updateInputsAndPreview(p.lat, p.lng);
                    });

                    window.profileMap.on('click', function(e) {
                        const p = e.latlng;
                        if (window.profileMarker) window.profileMarker.setLatLng(p);
                        else window.profileMarker = L.marker(p, { draggable: true }).addTo(window.profileMap);
                        updateInputsAndPreview(p.lat, p.lng);
                    });
                } else {
                    window.profileMap.invalidateSize();
                    window.profileMap.setView([latNum, lngNum], 15);
                    if (window.profileMarker) window.profileMarker.setLatLng([latNum, lngNum]);
                    else window.profileMarker = L.marker([latNum, lngNum], { draggable: true }).addTo(window.profileMap);
                }
            } catch (err) {
                console.error('Leaflet init error', err);
            }
        });
    }

    // Use current location button handler (attach once)
    (function attachUseLocation() {
        const useBtn = document.getElementById('useLocationBtn');
        if (!useBtn) return;
        useBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            useBtn.disabled = true;
            const prevText = useBtn.textContent;
            useBtn.textContent = 'Detecting...';
            navigator.geolocation.getCurrentPosition(function(pos) {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const latEl = document.getElementById('latitudeInput');
                const lngEl = document.getElementById('longitudeInput');
                if (latEl) latEl.value = parseFloat(lat).toFixed(6);
                if (lngEl) lngEl.value = parseFloat(lng).toFixed(6);
                showLocationPreview(lat, lng);
                useBtn.textContent = prevText;
                useBtn.disabled = false;
            }, function(err) {
                alert('Unable to get location: ' + (err.message || err.code));
                useBtn.textContent = prevText;
                useBtn.disabled = false;
            }, { timeout: 8000 });
        });
    })();
</script>

<style>
.batch-item:hover {
    background-color: #f8f9fa;
}

.batch-item.card {
    transition: all 0.3s ease;
}

.batch-item.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-group .btn.active {
    background-color: #198754;
    border-color: #198754;
    color: white;
}

.progress {
    background-color: #e9ecef;
}
</style>
{% endblock %}