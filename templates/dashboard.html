{% extends "base.html" %}

{% block content %}
<div class="container-lg py-5">
    <!-- Welcome Hero Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); border-radius: 20px; padding: 3rem 2rem; box-shadow: 0 10px 40px rgba(5,150,105,0.15);">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 style="font-size: 2.5rem; font-weight: 800; color: #ffffff; margin-bottom: 0.5rem;"><span id="dashWelcome">üåæ Welcome</span>, <span style="color: #d1fae5;">{{ session.get('user_name', 'Farmer') }}</span>!</h1>
                        <p style="font-size: 1.1rem; color: rgba(255,255,255,0.85);" id="dashSubtitle">Monitor your crops and reduce food loss with real-time insights</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <small style="color: rgba(255,255,255,0.8); display: block;" id="dashMemberSince">Member since</small>
                            <p style="font-size: 1.3rem; color: #ffffff; margin: 0.5rem 0 0 0; font-weight: 700;" id="dashCropCount">0</p>
                            <p style="font-size: 0.95rem; color: rgba(255,255,255,0.9); margin: 0.75rem 0 0 0;" id="dashMemberDate">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards - Modern Layout -->
    <div class="row mb-5 g-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel1" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Active Batches</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="activeBatches">0</h2>
                            <small id="dashSub1" style="color: #6b7280;">Currently monitored</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">üå±</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 65%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel2" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Total Storage</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="totalWeight">0 kg</h2>
                            <small id="dashSub2" style="color: #6b7280;">Combined weight</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">üì¶</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 45%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel3" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Food Saved</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="foodSaved">0 kg</h2>
                            <small id="dashSub3" style="color: #6b7280;">Loss prevention</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">ü•ó</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 75%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel4" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Success Rate</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="successRate">0%</h2>
                            <small id="dashSub4" style="color: #6b7280;">Overall performance</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">üìà</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>



    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-4">
            <!-- Quick Actions Card -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1); margin-bottom: 2rem;">
                <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; padding: 1.5rem;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="quickActionsTitle">üöÄ Quick Actions</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-grid gap-3">
                        <a href="{{ url_for('crops.add_crop') }}" class="btn" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(5,150,105,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            ‚ûï <span id="btnAddCrop">Add New Crop</span>
                        </a>
                        <a href="{{ url_for('gemini.ai_helper') }}" class="btn" style="background: rgba(59,130,246,0.1); color: #1d4ed8; border: 2px solid #3b82f6; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59,130,246,0.1)'; this.style.color='#1d4ed8';">
                            üåø <span id="btnAiHelper">Plant Disease Analyzer</span>
                        </a>

                        <!-- New: Voice Assistant button (navigates to dedicated voice page) -->
                        <a href="{{ url_for('gemini.voice') }}" class="btn" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(99,102,241,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            üó£Ô∏è <span id="btnVoiceAssistant">Voice Assistant</span>
                        </a>

                        <a href="{{ url_for('auth.profile') }}" class="btn" style="background: rgba(5,150,105,0.08); color: #059669; border: 2px solid #059669; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#059669'; this.style.color='white';" onmouseout="this.style.background='rgba(5,150,105,0.08)'; this.style.color='#059669';">
                            üë§ <span id="btnMyProfile">My Profile</span>
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn" style="background: rgba(220,38,38,0.08); color: #dc2626; border: 2px solid #dc2626; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#dc2626'; this.style.color='white';" onmouseout="this.style.background='rgba(220,38,38,0.08)'; this.style.color='#dc2626';">
                            üö™ <span id="btnLogout">Logout</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Badges Card -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 1.5rem;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="achievementsTitle">üèÜ Your Achievements</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row text-center g-3" id="badgesContainer">
                        <div class="col-4">
                            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px;">
                                üëã
                            </div>
                            <small>Welcome</small>
                        </div>
                        <div class="col-4">
                            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                                üå±
                            </div>
                            <small>First Crop</small>
                        </div>
                        <div class="col-4">
                            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                                üí™
                            </div>
                            <small>Risk Master</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-8">
            <!-- Active Batches Card -->
            <div class="card border-0 mb-4" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="activeBatchesTitle">üå± Active Crop Batches</h5>
                    <div class="d-flex gap-2">
                        <span class="badge" style="background: rgba(255,255,255,0.25); color: white; padding: 0.5rem 1rem; border-radius: 20px;" id="activeCount">0 active</span>
                        <a id="exportCsvBtn" class="btn btn-light btn-sm" href="{{ url_for('api.export_crops_csv') }}" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;" title="Export batches to CSV"><span id="exportBtn">üì• Export</span></a>
                        <a id="exportLossBtn" class="btn btn-light btn-sm" href="{{ url_for('api.export_loss_events_csv') }}" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;" title="Export loss/damage data to CSV"><span id="exportLossText">üìä Export Loss</span></a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div id="activeBatchesList">
                        <div class="text-center py-5">
                            <div class="spinner-border" style="color: #059669;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3" style="color: #6b7280;">Loading your crop data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Card -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border: none; padding: 1.5rem;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="weatherTitle">üå§Ô∏è Weather Advisory</h5>
                </div>
                <div class="card-body p-4">
                    <div style="background: rgba(3, 102, 214, 0.05); padding: 1.5rem; border-left: 4px solid #0284c7; border-radius: 8px; margin-bottom: 1.5rem;">
                        <p id="weatherAlert" style="margin: 0; color: #1e293b; font-weight: 500;">Loading weather information...</p>
                    </div>
                    <div class="row text-center g-3" id="weatherForecast">
                        <!-- Weather data loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Floating Microphone Button -->
<!-- Voice floating mic and status removed (use Voice Assistant in Quick Actions) -->
{% endblock %}

{% block scripts %}
<script>
// Translation dictionary for dashboard - DEFINE FIRST
const dashboardTranslations = {
    'en': {
        'dashLabel1': 'Active Batches',
        'dashSub1': 'Currently monitored',
        'dashLabel2': 'Total Storage',
        'dashSub2': 'Combined weight',
        'dashLabel3': 'Food Saved',
        'dashSub3': 'Loss prevention',
        'dashLabel4': 'Success Rate',
        'dashSub4': 'Overall performance',
        'quickActionsTitle': 'üöÄ Quick Actions',
        'btnAddCrop': 'Add New Crop',
        'btnAiHelper': 'Plant Disease Analyzer',
        'btnMyProfile': 'My Profile',
        'btnLogout': 'Logout',
        'btnVoiceAssistant': 'Voice Assistant',
        'achievementsTitle': 'üèÜ Your Achievements',
        'activeBatchesTitle': 'üå± Active Crop Batches',
        'exportBtn': 'üì• Export',
        'exportLossText': 'üìä Export Loss',
        'weatherTitle': 'üå§Ô∏è Weather Advisory',
        'dashWelcome': 'üåæ Welcome',
        'dashSubtitle': 'Monitor your crops and reduce food loss with real-time insights',
        'dashMemberSince': 'Member since',
        'dashCropCount': 'crops',
        'voiceListening': 'Listening...',
        'voiceProcessing': 'Processing your question...',
        'voiceSpeaking': 'Speaking answer...',
        'voiceError': 'Voice error: ',
        'voiceNotSupported': 'Voice recognition not supported in this browser.',
        'voicePermissionDenied': 'Microphone permission denied. Please allow microphone access.'
    },
    'bn': {
        'dashLabel1': '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        'dashSub1': '‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ',
        'dashLabel2': '‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π',
        'dashSub2': '‡¶∏‡¶Æ‡ßç‡¶Æ‡¶ø‡¶≤‡¶ø‡¶§ ‡¶ì‡¶ú‡¶®',
        'dashLabel3': '‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§',
        'dashSub3': '‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡ßã‡¶ß',
        'dashLabel4': '‡¶∏‡¶æ‡¶´‡¶≤‡ßç‡¶Ø‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞',
        'dashSub4': '‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ',
        'quickActionsTitle': 'üöÄ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™',
        'btnAddCrop': '‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∏‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
        'btnAiHelper': '‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶∞‡ßã‡¶ó ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶ï',
        'btnMyProfile': '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
        'btnLogout': '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü',
        'btnVoiceAssistant': '‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∏‡¶π‡¶ï‡¶æ‡¶∞‡ßÄ',
        'achievementsTitle': 'üèÜ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶ú‡¶®',
        'activeBatchesTitle': 'üå± ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        'exportBtn': 'üì• ‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø',
        'exportLossText': 'üìä ‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø',
        'weatherTitle': 'üå§Ô∏è ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂',
        'dashWelcome': 'üåæ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ',
        'dashSubtitle': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶¶‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶∏‡¶π ‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶®',
        'dashMemberSince': '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®',
        'dashCropCount': '‡¶´‡¶∏‡¶≤',
        'voiceListening': '‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...',
        'voiceProcessing': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...',
        'voiceSpeaking': '‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¨‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...',
        'voiceError': '‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ',
        'voiceNotSupported': '‡¶è‡¶á ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶∞‡¶ø‡¶ï‡¶ó‡¶®‡¶ø‡¶∂‡¶® ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º‡•§',
        'voicePermissionDenied': '‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶Ö‡¶∏‡ßç‡¶¨‡ßÄ‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'
    }
};

// Merge dashboard translations into global translations
Object.assign(translations['en'], dashboardTranslations['en']);
Object.assign(translations['bn'], dashboardTranslations['bn']);

// Load dashboard data
async function loadDashboardData() {
    try {
        // Load user info first (for member since)
        await loadUserInfo();
        
        // Load crop stats
        await loadCropStats();
        
        // Load active batches
        await loadActiveBatches();
        
        // Load weather data
        loadWeatherData();
        
        // Load badges
        loadBadges();

    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Load user information
async function loadUserInfo() {
    try {
        const response = await fetch('/api/user/info');
        if (response.ok) {
            const userInfo = await response.json();
            // Display member since date below crops count
            const memberDateElement = document.getElementById('dashMemberDate');
            
            if (userInfo.created_at_bn) {
                memberDateElement.textContent = userInfo.created_at_bn;
            }
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

// Load crop statistics
async function loadCropStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        if (response.ok) {
            const stats = await response.json();
            updateStatsDisplay(stats);
        } else {
            updateStatsDisplay({
                active_batches: 0,
                total_weight: 0,
                saved_food: 0,
                success_rate: 0
            });
        }
    } catch (error) {
        console.error('Error loading crop stats:', error);
        updateStatsDisplay({
            active_batches: 0,
            total_weight: 0,
            saved_food: 0,
            success_rate: 0
        });
    }
}

// Update stats display
function updateStatsDisplay(stats) {
    document.getElementById('activeBatches').textContent = stats.active_batches || 0;
    document.getElementById('totalWeight').textContent = (stats.total_weight || 0) + ' kg';
    document.getElementById('foodSaved').textContent = (stats.saved_food || 0) + ' kg';
    document.getElementById('successRate').textContent = (stats.success_rate || 0) + '%';
    document.getElementById('activeCount').textContent = (stats.active_batches || 0) + ' active';
    document.getElementById('dashCropCount').textContent = stats.active_batches || 0;
    updateLanguageForStats();
}

// Update stats labels based on current language
function updateLanguageForStats() {
    const t = translations[currentLang] || translations['en'];
    const statIds = [
        'dashLabel1', 'dashSub1', 'dashLabel2', 'dashSub2',
        'dashLabel3', 'dashSub3', 'dashLabel4', 'dashSub4'
    ];
    statIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && t[id]) {
            el.textContent = t[id];
        }
    });
}

// Load active batches
async function loadActiveBatches() {
    try {
        const response = await fetch('/api/crops/active');
        if (response.ok) {
            const batches = await response.json();
            displayActiveBatches(batches);
        }
    } catch (error) {
        console.error('Error loading active batches:', error);
    }
}

// Display active batches
function displayActiveBatches(batches) {
    const batchesList = document.getElementById('activeBatchesList');
    
    if (!batches || batches.length === 0) {
        batchesList.innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted">‡¶ï‡ßã‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>
                <a href="{{ url_for('crops.add_crop') }}" class="btn btn-success">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a>
            </div>
        `;
        return;
    }
    
    batchesList.innerHTML = batches.map(batch => `
        <a href="/crop/${batch.id}" style="text-decoration: none; color: inherit;">
            <div class="batch-item border-bottom pb-3 mb-3" style="cursor: pointer; transition: all 0.3s ease; border-left: 4px solid #059669; padding-left: 1rem; margin-left: -1rem;">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-1 text-capitalize" style="font-weight: 700; color: #047857;">${batch.crop_type || '‡¶´‡¶∏‡¶≤'}</h6>
                        <small class="text-muted">
                            üìç ${batch.storage_location || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ'} ‚Ä¢ 
                            üóìÔ∏è ${new Date(batch.harvest_date).toLocaleDateString('bn-BD')}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${100 - (batch.loss_percentage || 0)}%"></div>
                        </div>
                        <small>${batch.estimated_weight || 0} ‡¶ï‡ßá‡¶ú‡¶ø ‚Ä¢ ${batch.loss_percentage || 0}% ‡¶ï‡ßç‡¶∑‡¶§‡¶ø</small>
                    </div>
                    <div class="col-md-2 text-end">
                        <span class="badge bg-${getRiskLevelColor(batch.current_risk_level)}" style="padding: 0.5rem 0.75rem; font-size: 0.85rem;">
                            ${getRiskLevelBangla(batch.current_risk_level)}
                        </span>
                    </div>
                </div>
            </div>
        </a>
    `).join('');
}

// Get color for risk level
function getRiskLevelColor(riskLevel) {
    switch (riskLevel) {
        case 'high': return 'danger';
        case 'medium': return 'warning';
        case 'low': 
        default: return 'success';
    }
}

// Get Bangla text for risk level
function getRiskLevelBangla(riskLevel) {
    switch (riskLevel) {
        case 'high': return 'üî¥ ‡¶â‡¶ö‡ßç‡¶ö ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø';
        case 'medium': return 'üü° ‡¶Æ‡¶ß‡ßç‡¶Ø‡¶Æ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø';
        case 'low': 
        default: return 'üü¢ ‡¶ï‡¶Æ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø';
    }
}

// Load weather data
// Load weather data from API
async function loadWeatherData() {
    const weatherAlert = document.getElementById('weatherAlert');
    const weatherForecast = document.getElementById('weatherForecast');
    
    try {
        // Get user's default location (Dhaka for now, can be enhanced with user preferences)
        const location = 'dhaka';
        
        const response = await fetch(`/api/weather/${location}`);
        if (!response.ok) throw new Error('Failed to fetch weather');
        
        const weather = await response.json();
        
        // Display alert
        const currentTemp = weather.current_temp;
        let alertMsg = '‚úÖ ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶¨‡¶æ‡¶®‡ßç‡¶ß‡¶¨ ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá‡•§ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶Ø‡¶§‡ßç‡¶® ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§';
        
        if (weather.current_humidity > 85) {
            alertMsg = '‚ö†Ô∏è ‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø - ‡¶õ‡¶§‡ßç‡¶∞‡¶æ‡¶ï ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡•§ ‡¶¨‡¶æ‡¶Ø‡¶º‡ßÅ‡¶ö‡¶≤‡¶æ‡¶ö‡¶≤ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
        } else if (currentTemp > 35) {
            alertMsg = 'üå°Ô∏è ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶Ö‡¶®‡ßá‡¶ï ‡¶¨‡ßá‡¶∂‡¶ø - ‡¶´‡¶∏‡¶≤ ‡¶¢‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§';
        } else if (weather.forecasts[0]?.rain_chance > 80) {
            alertMsg = 'üåßÔ∏è ‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡¶®‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø - ‡¶´‡¶∏‡¶≤ ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§';
        }
        
        weatherAlert.innerHTML = `<strong>${alertMsg}</strong>`;
        
        // Display forecast
        if (weather.forecasts && weather.forecasts.length > 0) {
            weatherForecast.innerHTML = weather.forecasts.slice(0, 5).map((day, idx) => {
                const rainIcon = day.rain_chance > 50 ? 'üåßÔ∏è' : day.rain_chance > 20 ? '‚õÖ' : '‚òÄÔ∏è';
                return `
                    <div class="col">
                        <small style="font-weight: 600;">${idx === 0 ? '‡¶Ü‡¶ú' : idx === 1 ? '‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤' : idx + ' ‡¶¶‡¶ø‡¶®'}</small>
                        <div style="font-size: 1.2rem; margin: 0.5rem 0;">${rainIcon} ${day.temp}¬∞C</div>
                        <small style="color: #6b7280;">‡¶®‡¶Æ‡¶ø: ${day.humidity}%</small><br>
                        <small style="color: #059669; font-weight: 500;">‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø: ${day.rain_chance.toFixed(0)}%</small>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading weather:', error);
        weatherAlert.innerHTML = `<strong>‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶Ø‡¶§‡ßç‡¶® ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§</strong>`;
    }
}

// Load badges
function loadBadges() {
    const badgesContainer = document.getElementById('badgesContainer');
    
    badgesContainer.innerHTML = `
        <div class="col-4 mb-3">
            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px;">
                üëã
            </div>
            <small>Welcome</small>
        </div>
        <div class="col-4 mb-3">
            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                üå±
            </div>
            <small>First Crop</small>
        </div>
        <div class="col-4 mb-3">
            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                üí™
            </div>
            <small>Risk Master</small>
        </div>
    `;
}

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function(){
    // Load all dashboard data
    loadDashboardData();
    
    // Update content with current language
    updateContent();
    
    // Listen for language changes
    window.addEventListener('languageChanged', function() {
        updateContent();
    });
    
    
});
</script>

<style>
.batch-item:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
    margin: -10px;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    border-bottom: 2px solid rgba(0,0,0,0.1);
}

.progress {
    background-color: #e9ecef;
}

.activity-item {
    padding: 8px 0;
}
</style>
{% endblock %}
