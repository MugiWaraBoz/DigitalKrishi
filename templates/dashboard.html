{% extends "base.html" %}

{% block content %}
<div class="container-lg py-5">
    <!-- Welcome Hero Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div style="background: linear-gradient(135deg, #059669 0%, #047857 100%); border-radius: 20px; padding: 3rem 2rem; box-shadow: 0 10px 40px rgba(5,150,105,0.15);">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 style="font-size: 2.5rem; font-weight: 800; color: #ffffff; margin-bottom: 0.5rem;"><span id="dashWelcome">üåæ Welcome</span>, <span style="color: #d1fae5;">{{ session.get('user_name', 'Farmer') }}</span>!</h1>
                        <p style="font-size: 1.1rem; color: rgba(255,255,255,0.85);" id="dashSubtitle">Monitor your crops and reduce food loss with real-time insights</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);">
                            <small style="color: rgba(255,255,255,0.8); display: block;" id="dashMemberSince">Member since</small>
                            <p style="font-size: 1.3rem; color: #ffffff; margin: 0.5rem 0 0 0; font-weight: 700;" id="dashCropCount">0</p>
                            <p style="font-size: 0.95rem; color: rgba(255,255,255,0.9); margin: 0.75rem 0 0 0;" id="dashMemberDate">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards - Modern Layout -->
    <div class="row mb-5 g-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel1" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Active Batches</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="activeBatches">0</h2>
                            <small id="dashSub1" style="color: #6b7280;">Currently monitored</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">üå±</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 65%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel2" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Total Storage</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="totalWeight">0 kg</h2>
                            <small id="dashSub2" style="color: #6b7280;">Combined weight</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">üì¶</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 45%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel3" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Food Saved</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="foodSaved">0 kg</h2>
                            <small id="dashSub3" style="color: #6b7280;">Loss prevention</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">ü•ó</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 75%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <small id="dashLabel4" style="color: #059669; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Success Rate</small>
                            <h2 class="mt-2" style="color: #047857; font-weight: 800;" id="successRate">0%</h2>
                            <small id="dashSub4" style="color: #6b7280;">Overall performance</small>
                        </div>
                        <div style="font-size: 2.5rem; opacity: 0.8;">üìà</div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar" style="background: linear-gradient(90deg, #059669, #10b981); width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>



    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-lg-4">
            <!-- Quick Actions Card -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1); margin-bottom: 2rem;">
                <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; padding: 1.5rem;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="quickActionsTitle">üöÄ Quick Actions</h5>
                </div>
                <div class="card-body p-4">
                    <div class="d-grid gap-3">
                        <a href="{{ url_for('crops.add_crop') }}" class="btn" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(5,150,105,0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            ‚ûï <span id="btnAddCrop">Add New Crop</span>
                        </a>
                        <a href="{{ url_for('auth.profile') }}" class="btn" style="background: rgba(5,150,105,0.08); color: #059669; border: 2px solid #059669; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#059669'; this.style.color='white';" onmouseout="this.style.background='rgba(5,150,105,0.08)'; this.style.color='#059669';">
                            üë§ <span id="btnMyProfile">My Profile</span>
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="btn" style="background: rgba(220,38,38,0.08); color: #dc2626; border: 2px solid #dc2626; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; transition: all 0.3s ease;" onmouseover="this.style.background='#dc2626'; this.style.color='white';" onmouseout="this.style.background='rgba(220,38,38,0.08)'; this.style.color='#dc2626';">
                            üö™ <span id="btnLogout">Logout</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Badges Card -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 1.5rem;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="achievementsTitle">üèÜ Your Achievements</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row text-center g-3" id="badgesContainer">
                        <div class="col-4">
                            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px;">
                                üëã
                            </div>
                            <small>Welcome</small>
                        </div>
                        <div class="col-4">
                            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                                üå±
                            </div>
                            <small>First Crop</small>
                        </div>
                        <div class="col-4">
                            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                                üí™
                            </div>
                            <small>Risk Master</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-8">
            <!-- Active Batches Card -->
            <div class="card border-0 mb-4" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: none; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h5 class="mb-0" style="color: white; font-weight: 700;" id="activeBatchesTitle">üå± Active Crop Batches</h5>
                    <div class="d-flex gap-2">
                        <span class="badge" style="background: rgba(255,255,255,0.25); color: white; padding: 0.5rem 1rem; border-radius: 20px;" id="activeCount">0 active</span>
                        <a id="exportCsvBtn" class="btn btn-light btn-sm" href="{{ url_for('api.export_crops_csv') }}" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;" title="Export batches to CSV"><span id="exportBtn">üì• Export</span></a>
                        <a id="exportLossBtn" class="btn btn-light btn-sm" href="{{ url_for('api.export_loss_events_csv') }}" style="padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;" title="Export loss/damage data to CSV"><span id="exportLossText">üìä Export Loss</span></a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div id="activeBatchesList">
                        <div class="text-center py-5">
                            <div class="spinner-border" style="color: #059669;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3" style="color: #6b7280;">Loading your crop data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Card -->
            <div class="card border-0" style="box-shadow: 0 8px 25px rgba(5,150,105,0.1);">
                <div class="card-header" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border: none; padding: 1.5rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" style="color: white; font-weight: 700;" id="weatherTitle">üå§Ô∏è ‡¶´‡¶∏‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂</h5>
                        <button
                            type="button"
                            class="btn btn-sm btn-light"
                            style="border-radius: 999px; font-weight: 600; font-size: 0.85rem;"
                            data-bs-toggle="modal"
                            data-bs-target="#agriAdvisoryModal"
                            onclick="loadAgriAdvisory()"
                        >
                            üåæ ‡ß≠ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶´‡¶∏‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂
                        </button>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div style="background: rgba(3, 102, 214, 0.05); padding: 1.5rem; border-left: 4px solid #0284c7; border-radius: 8px; margin-bottom: 1.5rem;">
                        <p id="weatherAlert" style="margin: 0; color: #1e293b; font-weight: 500;">Loading crop advisory...</p>
                    </div>
                    <div class="row text-center g-3" id="weatherForecast">
                        <!-- Weather data loaded here -->
                    </div>

                    <!-- Advisory generator UI (server-side) -->
                    <div class="mt-4" id="serverAdvisory">
                        <h6 style="font-weight:700;">üîî ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ (‡¶ï‡ßÉ‡¶∑‡¶ï‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)</h6>
                        <form id="advisoryForm" class="row g-2 align-items-end" style="margin-top:0.5rem;" onsubmit="return false;">
                            <div class="col-md-4">
                                <label class="form-label">‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡ßü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¶‡¶ø‡¶®</label>
                                <select id="advisoryWeatherDay" class="form-select">
                                    <option value="0">‡¶Ü‡¶ú</option>
                                    <option value="1">‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤</option>
                                    <option value="2">2 ‡¶¶‡¶ø‡¶®</option>
                                    <option value="3">3 ‡¶¶‡¶ø‡¶®</option>
                                    <option value="4">4 ‡¶¶‡¶ø‡¶®</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">‡¶Æ‡ßå‡¶∏‡ßÅ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                                <select id="advisorySeason" class="form-select">
                                    <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï) --</option>
                                    <option value="spring">‡¶¨‡¶∏‡¶®‡ßç‡¶§ (Spring)</option>
                                    <option value="summer">‡¶ó‡ßç‡¶∞‡ßÄ‡¶∑‡ßç‡¶Æ (Summer)</option>
                                    <option value="autumn">‡¶∂‡¶∞‡¶§/‡¶∂‡¶∞‡ßé (Autumn/Fall)</option>
                                    <option value="winter">‡¶∂‡ßÄ‡¶§ (Winter)</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø</label>
                                <select id="advisoryMode" class="form-select">
                                    <option value="all" selected>‡¶∏‡¶¨ ‡¶´‡¶∏‡¶≤</option>
                                    <option value="active">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö</option>
                                </select>
                            </div>
                            <div class="col-md-2 text-end">
                                <button id="advisoryGenerateBtn" type="button" class="btn btn-primary" style="width:100%" onclick="generateForAllCropsFromForm()">‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                            </div>
                        </form>

                        <div id="serverAdvisoryResult" class="mt-3">
                            {% if advisory %}
                            <pre id="serverAdvisoryPre" style="white-space:pre-wrap; background:#f3f4f6; padding:12px; border-radius:8px;">{{ advisory }}</pre>
                            {% else %}
                            <div class="text-muted">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶è‡¶ñ‡¶®‡¶ì ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Translation dictionary for dashboard - DEFINE FIRST
const dashboardTranslations = {
    'en': {
        'dashLabel1': 'Active Batches',
        'dashSub1': 'Currently monitored',
        'dashLabel2': 'Total Storage',
        'dashSub2': 'Combined weight',
        'dashLabel3': 'Food Saved',
        'dashSub3': 'Loss prevention',
        'dashLabel4': 'Success Rate',
        'dashSub4': 'Overall performance',
        'quickActionsTitle': 'üöÄ Quick Actions',
        'btnAddCrop': 'Add New Crop',
        'btnMyProfile': 'My Profile',
        'btnLogout': 'Logout',
        'achievementsTitle': 'üèÜ Your Achievements',
        'activeBatchesTitle': 'üå± Active Crop Batches',
        'exportBtn': 'üì• Export',
        'exportLossText': 'üìä Export Loss',
        'weatherTitle': 'üå§Ô∏è Crop Advisory',
        'dashWelcome': 'üåæ Welcome',
        'dashSubtitle': 'Monitor your crops and reduce food loss with real-time insights',
        'dashMemberSince': 'Member since',
        'dashCropCount': 'crops'
    },
    'bn': {
        'dashLabel1': '‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        'dashSub1': '‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ',
        'dashLabel2': '‡¶Æ‡ßã‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π',
        'dashSub2': '‡¶∏‡¶Æ‡ßç‡¶Æ‡¶ø‡¶≤‡¶ø‡¶§ ‡¶ì‡¶ú‡¶®',
        'dashLabel3': '‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§',
        'dashSub3': '‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡ßã‡¶ß',
        'dashLabel4': '‡¶∏‡¶æ‡¶´‡¶≤‡ßç‡¶Ø‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞',
        'dashSub4': '‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ',
        'quickActionsTitle': 'üöÄ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™',
        'btnAddCrop': '‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∏‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
        'btnMyProfile': '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
        'btnLogout': '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü',
        'achievementsTitle': 'üèÜ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶ú‡¶®',
        'activeBatchesTitle': 'üå± ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö',
        'exportBtn': 'üì• ‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø',
        'exportLossText': 'üìä ‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶∞‡¶™‡ßç‡¶§‡¶æ‡¶®‡¶ø',
        'weatherTitle': 'üå§Ô∏è ‡¶´‡¶∏‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂',
        'dashWelcome': 'üåæ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ',
        'dashSubtitle': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶¶‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶∏‡¶π ‡¶ñ‡¶æ‡¶¶‡ßç‡¶Ø ‡¶ï‡ßç‡¶∑‡¶§‡¶ø ‡¶ï‡¶Æ‡¶æ‡¶®',
        'dashMemberSince': '‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®',
        'dashCropCount': '‡¶´‡¶∏‡¶≤'
    }
};

// Merge dashboard translations into global translations
Object.assign(translations['en'], dashboardTranslations['en']);
Object.assign(translations['bn'], dashboardTranslations['bn']);

// Load dashboard data
async function loadDashboardData() {
    try {
        // Load user info first (for member since)
        await loadUserInfo();
        
        // Load crop stats
        await loadCropStats();
        
        // Load active batches
        await loadActiveBatches();
        
        // Load weather data
        loadWeatherData();
        
        // Load badges
        loadBadges();

    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Load user information
async function loadUserInfo() {
    try {
        const response = await fetch('/api/user/info');
        if (response.ok) {
            const userInfo = await response.json();
            // Display member since date below crops count
            const memberDateElement = document.getElementById('dashMemberDate');
            
            if (userInfo.created_at_bn) {
                memberDateElement.textContent = userInfo.created_at_bn;
            }
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

// Load crop statistics
async function loadCropStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        if (response.ok) {
            const stats = await response.json();
            updateStatsDisplay(stats);
        } else {
            updateStatsDisplay({
                active_batches: 0,
                total_weight: 0,
                saved_food: 0,
                success_rate: 0
            });
        }
    } catch (error) {
        console.error('Error loading crop stats:', error);
        updateStatsDisplay({
            active_batches: 0,
            total_weight: 0,
            saved_food: 0,
            success_rate: 0
        });
    }
}

// Update stats display
function updateStatsDisplay(stats) {
    document.getElementById('activeBatches').textContent = stats.active_batches || 0;
    document.getElementById('totalWeight').textContent = (stats.total_weight || 0) + ' kg';
    document.getElementById('foodSaved').textContent = (stats.saved_food || 0) + ' kg';
    document.getElementById('successRate').textContent = (stats.success_rate || 0) + '%';
    document.getElementById('activeCount').textContent = (stats.active_batches || 0) + ' active';
    document.getElementById('dashCropCount').textContent = stats.active_batches || 0;
    updateLanguageForStats();
}

// Update stats labels based on current language
function updateLanguageForStats() {
    const t = translations[currentLang] || translations['en'];
    const statIds = [
        'dashLabel1', 'dashSub1', 'dashLabel2', 'dashSub2',
        'dashLabel3', 'dashSub3', 'dashLabel4', 'dashSub4'
    ];
    statIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && t[id]) {
            el.textContent = t[id];
        }
    });
}

// Load active batches
async function loadActiveBatches() {
    try {
        const response = await fetch('/api/crops/active');
        if (response.ok) {
            const batches = await response.json();
            displayActiveBatches(batches);
        }
    } catch (error) {
        console.error('Error loading active batches:', error);
    }
}

// Display active batches
function displayActiveBatches(batches) {
    const batchesList = document.getElementById('activeBatchesList');
    
    if (!batches || batches.length === 0) {
        batchesList.innerHTML = `
            <div class="text-center py-4">
                <p class="text-muted">‡¶ï‡ßã‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>
                <a href="{{ url_for('crops.add_crop') }}" class="btn btn-success">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ö ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</a>
            </div>
        `;
        return;
    }
    
    batchesList.innerHTML = batches.map(batch => `
        <a href="/crop/${batch.id}" style="text-decoration: none; color: inherit;">
            <div class="batch-item border-bottom pb-3 mb-3" style="cursor: pointer; transition: all 0.3s ease; border-left: 4px solid #059669; padding-left: 1rem; margin-left: -1rem;">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <h6 class="mb-1 text-capitalize" style="font-weight: 700; color: #047857;">${batch.crop_type || '‡¶´‡¶∏‡¶≤'}</h6>
                        <small class="text-muted">
                            üìç ${batch.storage_location || '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ'} ‚Ä¢ 
                            üóìÔ∏è ${new Date(batch.harvest_date).toLocaleDateString('bn-BD')}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${100 - (batch.loss_percentage || 0)}%"></div>
                        </div>
                        <small>${batch.estimated_weight || 0} ‡¶ï‡ßá‡¶ú‡¶ø ‚Ä¢ ${batch.loss_percentage || 0}% ‡¶ï‡ßç‡¶∑‡¶§‡¶ø</small>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="badge bg-${getRiskLevelColor(batch.current_risk_level)} mb-2" style="padding: 0.5rem 0.75rem; font-size: 0.85rem; display: inline-block;">
                            ${getRiskLevelBangla(batch.current_risk_level)}
                        </span>
                        <br>
                        <button
                            type="button"
                            class="btn btn-sm btn-outline-primary"
                            style="font-size: 0.8rem; padding: 0.25rem 0.6rem; border-radius: 999px;"
                            onclick="event.preventDefault(); event.stopPropagation(); window.location.href='/crop/${batch.id}#advisory';"
                        >
                            üîç ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®
                        </button>
                    </div>
                </div>
            </div>
        </a>
    `).join('');
}

// Get color for risk level
function getRiskLevelColor(riskLevel) {
    switch (riskLevel) {
        case 'high': return 'danger';
        case 'medium': return 'warning';
        case 'low': 
        default: return 'success';
    }
}

// Get Bangla text for risk level
function getRiskLevelBangla(riskLevel) {
    switch (riskLevel) {
        case 'high': return 'üî¥ ‡¶â‡¶ö‡ßç‡¶ö ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø';
        case 'medium': return 'üü° ‡¶Æ‡¶ß‡ßç‡¶Ø‡¶Æ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø';
        case 'low': 
        default: return 'üü¢ ‡¶ï‡¶Æ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø';
    }
}

// Load weather data with AI-generated crop advisories
async function loadWeatherData() {
    const weatherAlert = document.getElementById('weatherAlert');
    const weatherForecast = document.getElementById('weatherForecast');
    
    try {
        // Get user's active crops first
        const cropsResponse = await fetch('/api/crops/active');
        let userCrops = [];
        
        if (cropsResponse.ok) {
            const cropsData = await cropsResponse.json();
            userCrops = cropsData.map(crop => crop.crop_type).filter(Boolean);
        }
        
        // If no specific crops, use common ones
        if (userCrops.length === 0) {
            userCrops = ['‡¶ß‡¶æ‡¶®', '‡¶Ü‡¶≤‡ßÅ', '‡¶ü‡¶Æ‡ßá‡¶ü‡ßã', '‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ'];
        }

        // store latest for client-side advisory form
        window.latestUserCrops = userCrops;
        
        // Get weather data
        const location = 'dhaka';
        const response = await fetch(`/api/weather/${location}`);
        if (!response.ok) throw new Error('Failed to fetch weather');
        
        const weather = await response.json();
        
        // Generate AI-powered crop advisories (server-side) and display
        window.latestWeather = weather;
        const advisory = await generateCropAdvisory(userCrops, weather);

        // Display the advisory
        weatherAlert.innerHTML = `<strong>${advisory}</strong>`;
        
        // Display forecast
        if (weather.forecasts && weather.forecasts.length > 0) {
            weatherForecast.innerHTML = weather.forecasts.slice(0, 5).map((day, idx) => {
                const rainIcon = day.rain_chance > 50 ? 'üåßÔ∏è' : day.rain_chance > 20 ? '‚õÖ' : '‚òÄÔ∏è';
                return `
                    <div class="col">
                        <small style="font-weight: 600;">${idx === 0 ? '‡¶Ü‡¶ú' : idx === 1 ? '‡¶Ü‡¶ó‡¶æ‡¶Æ‡ßÄ‡¶ï‡¶æ‡¶≤' : idx + ' ‡¶¶‡¶ø‡¶®'}</small>
                        <div style="font-size: 1.2rem; margin: 0.5rem 0;">${rainIcon} ${day.temp}¬∞C</div>
                        <small style="color: #6b7280;">‡¶®‡¶Æ‡¶ø: ${day.humidity}%</small><br>
                        <small style="color: #059669; font-weight: 500;">‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø: ${day.rain_chance || 0}%</small>
                    </div>
                `;
            }).join('');
        }

    } catch (error) {
        console.error('Error loading weather:', error);
        weatherAlert.innerHTML = `<strong>‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶Ø‡¶§‡ßç‡¶® ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§</strong>`;
    }
}

// Generate AI-powered crop advisory
async function generateCropAdvisory(crops, weather) {
    try {
        // Get today's weather
        const today = weather.forecasts?.[0] || weather.current || {};
        if (!today) return '‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶Ø‡¶§‡ßç‡¶® ‡¶®‡¶ø‡¶®‡•§';

        // Call server-side advisory generator for more authoritative Bangla advisories
        const payload = {
            crops: crops.slice(0, 6), // limit to 6 crops
            weather: {
                temperature: today.temperature || today.temp || weather.current?.temperature || null,
                humidity: today.humidity || weather.current?.humidity || null,
                rain_chance: today.rain_chance || today.rainfall || null,
                condition: (today.condition || weather.current?.condition || '').toString()
            },
            season: null
        };

        const res = await fetch('/advisory/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            console.error('Server advisory generator failed', res.status);
            return '‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø ‚Äî ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
        }

        const data = await res.json();
        if (data && Array.isArray(data.advisories) && data.advisories.length) {
            return data.advisories.join('\n\n');
        }

        return '‡¶∏‡¶¨ ‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶ï‡ßÇ‡¶≤ ‡¶Ü‡¶¨‡¶π‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡•§ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶ö‡¶∞‡ßç‡¶Ø‡¶æ ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§';

    } catch (error) {
        console.error('Error generating advisory:', error);
        return '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø‡¶ï‡¶∞ ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶ö‡¶∞‡ßç‡¶Ø‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
    }
}

// Generate advisories for all farmer crops using current cached weather/crops
async function generateForAllCropsFromForm() {
    try {
        const dayIndex = parseInt(document.getElementById('advisoryWeatherDay').value || '0', 10);
        const season = (document.getElementById('advisorySeason').value || '').trim() || null;

        const crops = window.latestUserCrops && window.latestUserCrops.length ? window.latestUserCrops : ['‡¶ß‡¶æ‡¶®','‡¶Ü‡¶≤‡ßÅ','‡¶ü‡¶Æ‡ßá‡¶ü‡ßã'];
        const weather = window.latestWeather || {};
        const selected = (weather.forecasts && weather.forecasts[dayIndex]) || weather.current || {};

        const payload = {
            crops: crops,
            weather: {
                temperature: selected.temperature || selected.temp || weather.current?.temperature || null,
                humidity: selected.humidity || weather.current?.humidity || null,
                rain_chance: selected.rain_chance || selected.rainfall || null,
                condition: (selected.condition || weather.current?.condition || '').toString()
            },
            season: season
        };

        // show loading
        const resultEl = document.getElementById('serverAdvisoryResult');
        if (resultEl) resultEl.innerHTML = `<div class="text-center py-3">‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶π‡¶ö‡ßç‡¶õ‡ßá... <span class="spinner-border spinner-border-sm" role="status"></span></div>`;

        const res = await fetch('/advisory/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            if (resultEl) resultEl.innerHTML = `<div class="text-danger">‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø (‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ${res.status})</div>`;
            return;
        }

        const data = await res.json();
        if (!data || !Array.isArray(data.advisories)) {
            if (resultEl) resultEl.innerHTML = `<div class="text-warning">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;
            return;
        }

        // render advisories
        const html = data.advisories.map(a => `<pre style="white-space:pre-wrap; background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:8px;">${a}</pre>`).join('\n');
        if (resultEl) resultEl.innerHTML = html || `<div class="text-muted">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</div>`;

    } catch (err) {
        console.error('Error in generateForAllCropsFromForm', err);
        const resultEl = document.getElementById('serverAdvisoryResult');
        if (resultEl) resultEl.innerHTML = `<div class="text-danger">‡¶Ö‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶§ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§</div>`;
    }
}

// Get crop-specific advisory using AI logic
async function getCropSpecificAdvisory(crop, todayWeather, currentWeather) {
    // Map crop names to standardized types
    const cropMap = {
        '‡¶ß‡¶æ‡¶®': 'rice', '‡¶ö‡¶æ‡¶≤': 'rice', 'paddy': 'rice',
        '‡¶Ü‡¶≤‡ßÅ': 'potato', 'potato': 'potato',
        '‡¶ü‡¶Æ‡ßá‡¶ü‡ßã': 'tomato', 'tomato': 'tomato',
        '‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ': 'maize', 'corn': 'maize', '‡¶Æ‡ßá‡¶á‡¶ú': 'maize',
        '‡¶™‡ßá‡¶Å‡¶Ø‡¶º‡¶æ‡¶ú': 'onion', 'onion': 'onion'
    };
    
    const cropType = cropMap[crop.toLowerCase()] || 'general';
    const temp = todayWeather.temperature || currentWeather.temperature || 25;
    const humidity = todayWeather.humidity || currentWeather.humidity || 60;
    const rainfall = todayWeather.rainfall || 0;
    const condition = todayWeather.condition || 'Clear';
    
    // AI Advisory Logic based on crop type, weather, and risk assessment
    let risk = 'Low';
    let advice = '';
    
    // Risk assessment
    if (rainfall > 50 || humidity > 85) risk = 'High';
    else if (rainfall > 20 || humidity > 75) risk = 'Moderate';
    
    // Crop-specific logic
    switch(cropType) {
        case 'rice':
            if (rainfall > 60) {
                advice = '‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø‡¶§‡ßá ‡¶ú‡¶Æ‡¶ø ‡¶≠‡ßá‡¶∏‡ßá ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶ú‡¶Æ‡¶ø‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶®‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                risk = 'High';
            } else if (humidity > 80) {
                advice = '‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶•‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º ‡¶¨‡ßç‡¶≤‡¶æ‡¶∏‡ßç‡¶ü ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡•§ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                risk = 'Moderate';
            } else {
                advice = '‡¶ß‡¶æ‡¶® ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶ö‡¶∞‡ßç‡¶Ø‡¶æ ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§';
            }
            break;
            
        case 'potato':
            if (humidity > 85) {
                advice = '‡¶â‡¶ö‡ßç‡¶ö ‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶≤‡ßÅ‡¶§‡ßá ‡¶´‡¶æ‡¶ô‡ßç‡¶ó‡¶æ‡¶∏ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡¶®‡¶æ‡•§ ‡¶ó‡ßÅ‡¶¶‡¶æ‡¶Æ‡ßá ‡¶¨‡¶æ‡¶Ø‡¶º‡ßÅ ‡¶ö‡¶≤‡¶æ‡¶ö‡¶≤ ‡¶¨‡¶æ‡¶°‡¶º‡¶æ‡¶®‡•§';
                risk = 'High';
            } else if (temp > 30) {
                advice = '‡¶â‡¶ö‡ßç‡¶ö ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶≤‡ßÅ‡¶∞ ‡¶Ö‡¶ô‡ßç‡¶ï‡ßÅ‡¶∞‡ßã‡¶¶‡¶ó‡¶Æ ‡¶¨‡¶æ‡¶°‡¶º‡ßá‡•§ ‡¶∂‡ßÄ‡¶§‡¶≤ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                risk = 'Moderate';
            } else {
                advice = '‡¶Ü‡¶≤‡ßÅ‡¶∞ ‡¶ó‡ßÅ‡¶¶‡¶æ‡¶Æ‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶¨‡¶ú‡¶æ‡¶Ø‡¶º ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§';
            }
            break;
            
        case 'tomato':
            if (temp > 35) {
                advice = '‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶§‡¶æ‡¶™‡ßá ‡¶ü‡¶Æ‡ßá‡¶ü‡ßã‡¶∞ ‡¶´‡ßÅ‡¶≤ ‡¶ù‡¶∞‡ßá ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶õ‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                risk = 'High';
            } else if (humidity > 80) {
                advice = '‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ‡¶Ø‡¶º ‡¶ü‡¶Æ‡ßá‡¶ü‡ßã ‡¶¨‡ßç‡¶≤‡¶æ‡¶á‡¶ü ‡¶∞‡ßã‡¶ó‡ßá‡¶∞ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∏‡ßç‡¶™‡ßç‡¶∞‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                risk = 'Moderate';
            } else {
                advice = '‡¶ü‡¶Æ‡ßá‡¶ü‡ßã ‡¶ó‡¶æ‡¶õ‡ßá‡¶∞ ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶≠‡¶æ‡¶≤‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶æ‡¶®‡¶ø ‡¶¶‡¶ø‡¶®‡•§';
            }
            break;
            
        case 'maize':
            if (rainfall > 40) {
                advice = '‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶ì ‡¶¨‡¶æ‡¶§‡¶æ‡¶∏‡ßá ‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ ‡¶ó‡¶æ‡¶õ ‡¶π‡ßá‡¶≤‡ßá ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶ó‡¶æ‡¶õ‡ßá‡¶∞ ‡¶ó‡ßã‡¶°‡¶º‡¶æ‡¶Ø‡¶º ‡¶Æ‡¶æ‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®‡•§';
                risk = 'High';
            } else if (temp < 18) {
                advice = '‡¶§‡¶æ‡¶™‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶ï‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶Ø‡¶º ‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡ßÉ‡¶¶‡ßç‡¶ß‡¶ø ‡¶ß‡ßÄ‡¶∞ ‡¶π‡¶¨‡ßá‡•§ ‡¶∏‡ßá‡¶ö ‡¶ï‡¶Æ‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡¶ø‡¶®‡•§';
                risk = 'Moderate';
            } else {
                advice = '‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶ö‡¶∞‡ßç‡¶Ø‡¶æ ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§';
            }
            break;
            
        case 'onion':
            if (humidity > 75) {
                advice = '‡¶Ü‡¶∞‡ßç‡¶¶‡ßç‡¶∞‡¶§‡¶æ‡¶Ø‡¶º ‡¶™‡ßá‡¶Å‡¶Ø‡¶º‡¶æ‡¶ú ‡¶™‡¶ö‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡•§ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∂‡ßÅ‡¶ï‡¶®‡¶æ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®‡•§';
                risk = 'High';
            } else if (rainfall > 30) {
                advice = '‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø‡¶∞ ‡¶™‡¶æ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡ßá‡¶Å‡¶Ø‡¶º‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ó‡ßã‡¶°‡¶º‡¶æ ‡¶™‡¶ö‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶™‡¶æ‡¶®‡¶ø ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡¶æ‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
                risk = 'Moderate';
            } else {
                advice = '‡¶™‡ßá‡¶Å‡¶Ø‡¶º‡¶æ‡¶ú ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂‡•§';
            }
            break;
            
        default:
            advice = '‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶´‡¶∏‡¶≤ ‡¶™‡¶∞‡¶ø‡¶ö‡¶∞‡ßç‡¶Ø‡¶æ ‡¶ö‡¶æ‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶®‡•§';
    }
    
    const riskIcons = {
        'High': 'üî¥',
        'Moderate': 'üü°', 
        'Low': 'üü¢'
    };
    
    return `${riskIcons[risk]} ${crop}: ${advice}`;
}

// Load 7-day agricultural advisory for all crops
async function loadAgriAdvisory() {
    const modalBody = document.getElementById('agriAdvisoryBody');

    if (!modalBody) return;

    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" style="color: #059669;" role="status">
                <span class="visually-hidden">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
            </div>
        </div>
    `;

    try {
        const location = 'dhaka';
        const response = await fetch(`/api/weather/agri/${location}`);
        if (!response.ok) throw new Error('Failed to fetch agri advisory');

        const data = await response.json();
        const advisories = data.advisories || [];

        if (!advisories.length) {
            modalBody.innerHTML = `
                <p class="text-center text-muted mb-0">
                    ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                </p>
            `;
            return;
        }

        modalBody.innerHTML = advisories.map(day => {
            const cropsHtml = Object.entries(day.crops || {}).map(([name, info]) => {
                const risk = (info.risk || 'Low').toLowerCase();
                let badgeClass = 'bg-success';
                if (risk === 'medium') badgeClass = 'bg-warning text-dark';
                else if (risk === 'high') badgeClass = 'bg-danger';
                else if (risk === 'critical') badgeClass = 'bg-dark';

                return `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="fw-semibold">${name}</span>
                            <div style="font-size: 0.9rem; color: #374151;">
                                ${info.advice || ''}
                            </div>
                        </div>
                        <span class="badge ${badgeClass}" style="min-width: 80px; text-align: center;">
                            ${info.risk}
                        </span>
                    </div>
                `;
            }).join('');

            return `
                <div class="mb-3 p-3 rounded-3" style="background: #f9fafb; border: 1px solid #e5e7eb;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${day.label}</strong>
                            <div style="font-size: 0.85rem; color: #6b7280;">${day.date}</div>
                        </div>
                        <span style="font-size: 0.8rem; color: #9ca3af;">${day.date_english}</span>
                    </div>
                    <div>
                        ${cropsHtml}
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading agri advisory:', error);
        modalBody.innerHTML = `
            <p class="text-center text-danger mb-0">
                ‡ß≠ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
            </p>
        `;
    }
}

// Load badges
function loadBadges() {
    const badgesContainer = document.getElementById('badgesContainer');
    
    badgesContainer.innerHTML = `
        <div class="col-4 mb-3">
            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px;">
                üëã
            </div>
            <small>Welcome</small>
        </div>
        <div class="col-4 mb-3">
            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                üå±
            </div>
            <small>First Crop</small>
        </div>
        <div class="col-4 mb-3">
            <div class="bg-light rounded-circle p-3 mx-auto" style="width: 70px; height: 70px; opacity: 0.5;">
                üí™
            </div>
            <small>Risk Master</small>
        </div>
    `;
}

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function(){
    // Load all dashboard data
    loadDashboardData();
    
    // Update content with current language
    updateContent();
    
    // Listen for language changes
    window.addEventListener('languageChanged', function() {
        updateContent();
    });
});
</script>

<style>
.batch-item:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 10px;
    margin: -10px;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    border-bottom: 2px solid rgba(0,0,0,0.1);
}

.progress {
    background-color: #e9ecef;
}

.activity-item {
    padding: 8px 0;
}
</style>
{% endblock %}

<!-- 7-day Agricultural Advisory Modal -->
<div class="modal fade" id="agriAdvisoryModal" tabindex="-1" aria-labelledby="agriAdvisoryLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
        <h5 class="modal-title" id="agriAdvisoryLabel" style="color: #ffffff; font-weight: 700;">
          üåæ ‡ß≠ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶´‡¶∏‡¶≤‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="agriAdvisoryBody" style="max-height: 70vh; overflow-y: auto;">
        <!-- Advisory content loaded dynamically -->
      </div>
    </div>
  </div>
</div>